<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kirill MÃ¼ller">
<meta name="dcterms.date" content="2024-04-02">
<meta name="description" content="Summarizing the progress of 2022 and 2023">

<title>R-DBI - The future of DBI, 2/*</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">R-DBI</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../backends/index.html"> 
<span class="menu-text">Backends</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overall" id="toc-overall" class="nav-link active" data-scroll-target="#overall">Overall</a>
  <ul class="collapse">
  <li><a href="#improve-cicd-infrastructure" id="toc-improve-cicd-infrastructure" class="nav-link" data-scroll-target="#improve-cicd-infrastructure">Improve CI/CD infrastructure</a></li>
  <li><a href="#documentation-improvements" id="toc-documentation-improvements" class="nav-link" data-scroll-target="#documentation-improvements">Documentation improvements</a></li>
  <li><a href="#move-to-cpp11" id="toc-move-to-cpp11" class="nav-link" data-scroll-target="#move-to-cpp11">Move to cpp11</a></li>
  </ul></li>
  <li><a href="#dbi-minor-update-to-1.2.2" id="toc-dbi-minor-update-to-1.2.2" class="nav-link" data-scroll-target="#dbi-minor-update-to-1.2.2">DBI: minor update to 1.2.2</a>
  <ul class="collapse">
  <li><a href="#integration-with-arrow" id="toc-integration-with-arrow" class="nav-link" data-scroll-target="#integration-with-arrow">Integration with Arrow</a></li>
  <li><a href="#object-identifiers" id="toc-object-identifiers" class="nav-link" data-scroll-target="#object-identifiers">Object identifiers</a></li>
  </ul></li>
  <li><a href="#dbitest-minor-update-to-1.8.1" id="toc-dbitest-minor-update-to-1.8.1" class="nav-link" data-scroll-target="#dbitest-minor-update-to-1.8.1">DBItest: minor update to 1.8.1</a>
  <ul class="collapse">
  <li><a href="#code-generation" id="toc-code-generation" class="nav-link" data-scroll-target="#code-generation">Code generation</a></li>
  <li><a href="#decoupling-from-backends" id="toc-decoupling-from-backends" class="nav-link" data-scroll-target="#decoupling-from-backends">Decoupling from backends</a></li>
  <li><a href="#other-improvements" id="toc-other-improvements" class="nav-link" data-scroll-target="#other-improvements">Other improvements</a></li>
  </ul></li>
  <li><a href="#rsqlite-minor-update-to-2.3.6-continuous-updates-following-upstream-sqlite-releases" id="toc-rsqlite-minor-update-to-2.3.6-continuous-updates-following-upstream-sqlite-releases" class="nav-link" data-scroll-target="#rsqlite-minor-update-to-2.3.6-continuous-updates-following-upstream-sqlite-releases">RSQLite: minor update to 2.3.6, continuous updates following upstream SQLite releases</a></li>
  <li><a href="#rpostgres-minor-update-to-1.4.6" id="toc-rpostgres-minor-update-to-1.4.6" class="nav-link" data-scroll-target="#rpostgres-minor-update-to-1.4.6">RPostgres: minor update to 1.4.6</a></li>
  <li><a href="#rmariadb-minor-update-to-1.3.1" id="toc-rmariadb-minor-update-to-1.3.1" class="nav-link" data-scroll-target="#rmariadb-minor-update-to-1.3.1">RMariaDB: minor update to 1.3.1</a></li>
  <li><a href="#adbi-new-release-in-collaboration-with-voltron-data-bridging-dbi-and-adbc-arrow-database-connectivity" id="toc-adbi-new-release-in-collaboration-with-voltron-data-bridging-dbi-and-adbc-arrow-database-connectivity" class="nav-link" data-scroll-target="#adbi-new-release-in-collaboration-with-voltron-data-bridging-dbi-and-adbc-arrow-database-connectivity">adbi: new release in collaboration with Voltron Data, bridging DBI and adbc (Arrow Database Connectivity)</a>
  <ul class="collapse">
  <li><a href="#dbi3" id="toc-dbi3" class="nav-link" data-scroll-target="#dbi3">dbi3?</a>
  <ul class="collapse">
  <li><a href="#review-async" id="toc-review-async" class="nav-link" data-scroll-target="#review-async">Review async</a></li>
  </ul></li>
  <li><a href="#what-is-dbi" id="toc-what-is-dbi" class="nav-link" data-scroll-target="#what-is-dbi">What is DBI?</a></li>
  <li><a href="#recent-developments" id="toc-recent-developments" class="nav-link" data-scroll-target="#recent-developments">Recent developments</a>
  <ul class="collapse">
  <li><a href="#clickable-method-documentation" id="toc-clickable-method-documentation" class="nav-link" data-scroll-target="#clickable-method-documentation">Clickable method documentation</a></li>
  <li><a href="#full-support-for-aws-redshift" id="toc-full-support-for-aws-redshift" class="nav-link" data-scroll-target="#full-support-for-aws-redshift">Full support for AWS Redshift</a></li>
  <li><a href="#faster-table-imports" id="toc-faster-table-imports" class="nav-link" data-scroll-target="#faster-table-imports">Faster table imports</a></li>
  <li><a href="#windows-compatibility" id="toc-windows-compatibility" class="nav-link" data-scroll-target="#windows-compatibility">Windows compatibility</a></li>
  <li><a href="#extended-data-types-for-sqlite" id="toc-extended-data-types-for-sqlite" class="nav-link" data-scroll-target="#extended-data-types-for-sqlite">Extended data types for SQLite</a></li>
  <li><a href="#interrupt-handling" id="toc-interrupt-handling" class="nav-link" data-scroll-target="#interrupt-handling">Interrupt handling</a></li>
  <li><a href="#automation" id="toc-automation" class="nav-link" data-scroll-target="#automation">Automation</a></li>
  <li><a href="#simpler-upgrade-path-for-dbitest" id="toc-simpler-upgrade-path-for-dbitest" class="nav-link" data-scroll-target="#simpler-upgrade-path-for-dbitest">Simpler upgrade path for DBItest</a></li>
  <li><a href="#inlined-boost-headers" id="toc-inlined-boost-headers" class="nav-link" data-scroll-target="#inlined-boost-headers">Inlined Boost headers</a></li>
  <li><a href="#reorganized-structure-of-the-r-code" id="toc-reorganized-structure-of-the-r-code" class="nav-link" data-scroll-target="#reorganized-structure-of-the-r-code">Reorganized structure of the R code</a></li>
  </ul></li>
  <li><a href="#future-work" id="toc-future-work" class="nav-link" data-scroll-target="#future-work">Future work</a>
  <ul class="collapse">
  <li><a href="#capabilities" id="toc-capabilities" class="nav-link" data-scroll-target="#capabilities">Capabilities</a></li>
  <li><a href="#separate-user-interface" id="toc-separate-user-interface" class="nav-link" data-scroll-target="#separate-user-interface">Separate user interface</a></li>
  </ul></li>
  <li><a href="#acknowledgments" id="toc-acknowledgments" class="nav-link" data-scroll-target="#acknowledgments">Acknowledgments</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">The future of DBI, 2/*</h1>
</div>

<div>
  <div class="description">
    Summarizing the progress of 2022 and 2023
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Kirill MÃ¼ller </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 2, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>TODO: Nicolas + Kirill one-on-one</p>
<p>TODO: Bump DBItest</p>
<p>TODO: CRAN release</p>
<p>TODO: Issue and PR stats</p>
<p>FIXME: dm</p>
<p>FIXME: adbi</p>
<p>TODO: Async</p>
<p>FIXME: Intro, summary</p>
<section id="overall" class="level2">
<h2 class="anchored" data-anchor-id="overall">Overall</h2>
<section id="improve-cicd-infrastructure" class="level3">
<h3 class="anchored" data-anchor-id="improve-cicd-infrastructure">Improve CI/CD infrastructure</h3>
<p>Packages run their own checks and the checks for related components. For example, DBI now runs DBItest with RSQLite, and DBItest runs checks for all backends, including odbc. This ensures interoperability between CRAN and development versions of the packages and helps to catch issues early.</p>
<ul>
<li><p>FIXME: Aviator</p></li>
<li><p>FIXME: fledge</p></li>
<li><p>FIXME: actions-sync</p></li>
<li><p>FIXME: rdb</p></li>
</ul>
</section>
<section id="documentation-improvements" class="level3">
<h3 class="anchored" data-anchor-id="documentation-improvements">Documentation improvements</h3>
<p>Various documentation improvements have been made:</p>
<ul>
<li><p>A new <a href="https://dbi.r-dbi.org/articles/DBI-arrow.html">vignette on Arrow support in DBI</a></p></li>
<li><p>DBI specification is now version-controlled as Markdown files (previously has been assembled at package build time from various sources)</p></li>
<li><p>Clarification of the command execution and data retrieval flow in the documentation</p></li>
<li><p>New pkgdown documentation template <a href="https://github.com/r-dbi/dbitemplate" class="uri">https://github.com/r-dbi/dbitemplate</a> that is used by all packages, thanks to MaÃ«lle Salmon</p></li>
</ul>
<p>Sundown of <a href="https://relational.fit.cvut.cz" class="uri">https://relational.fit.cvut.cz</a>: relational.fit was a website that hosted various relational data models in a publicly accessible MySQL database. We have secured a copy of the data and are working on a new hosting solution.</p>
<ul>
<li>FIXME: New blog</li>
</ul>
</section>
<section id="move-to-cpp11" class="level3">
<h3 class="anchored" data-anchor-id="move-to-cpp11">Move to cpp11</h3>
<p>The RSQLite, RPostgres, and RMariaDB packages are now using the cpp11 package for the glue between R and C++. This header-only package provides a modern C++11 interface to R, the header files can be vendored into the backend packages if needed. Other highlights include the use âUTF-8 everywhereâ paradigm, improved safety of C API calls, and a faster implementation of protection.</p>
</section>
</section>
<section id="dbi-minor-update-to-1.2.2" class="level2">
<h2 class="anchored" data-anchor-id="dbi-minor-update-to-1.2.2">DBI: minor update to 1.2.2</h2>
<section id="integration-with-arrow" class="level3">
<h3 class="anchored" data-anchor-id="integration-with-arrow">Integration with Arrow</h3>
<p>DBI backens can now optionally support Arrow arrays and streams as the primary data exchange format. This is accessed through the new generics <code>dbSendQueryArrow()</code>, <code>dbFetchArrow()</code>, <code>dbFetchArrowChunk()</code>, <code>dbGetQueryArrow()</code>, <code>dbReadTableArrow()</code>, <code>dbWriteTableArrow()</code>, <code>dbCreateTableArrow()</code>, <code>dbAppendTableArrow()</code>, and <code>dbBindArrow()</code>. A default implementation is provided in the DBI package, this means that the new interface can be used with any DBI backend without changes to the backend package. Performance and interoperability gains can be achieved by directly implementing the Arrow interface in the backend package, as the new adbi package does. More on that below, thanks to Voltron Data for supporting this effort!</p>
</section>
<section id="object-identifiers" class="level3">
<h3 class="anchored" data-anchor-id="object-identifiers">Object identifiers</h3>
<p>The <code>Id()</code> class has been changed to unnamed components, as the explicit naming of the components (âdatabaseâ, âschemaâ, âtableâ) was not used in practice. This also affects the <code>dbQuoteIdentifier()</code>, <code>dbUnquoteIdentifier()</code>, and <code>dbListObjects()</code> generics, which now accept and return unnamed <code>Id()</code> objects.</p>
</section>
</section>
<section id="dbitest-minor-update-to-1.8.1" class="level2">
<h2 class="anchored" data-anchor-id="dbitest-minor-update-to-1.8.1">DBItest: minor update to 1.8.1</h2>
<section id="code-generation" class="level3">
<h3 class="anchored" data-anchor-id="code-generation">Code generation</h3>
<p>Why <a href="https://mtlynch.io/good-developers-bad-tests/">good developers write bad unit tests</a>? I consider myself a good developer, and the DBItest package is a prime example of this. In a nutshell, production code should avoid repetition and hard-coded constant, while testing code should be as explicit and as easy to understand and execute as possible.</p>
<p>The DBItest package home to both the specification of the DBI package and a test suite for DBI backends. As such, good software engineering practices are actually helpful here and have helped cover many corner cases in the DBI backends. Running the tests in DBItest is easy, but in the case of a failure, the error messages are not always helpful. Backend developers typically have to read the test code to understand what went wrong. And if the actual test code hides between layers of abstraction, this can be a daunting task.</p>
<p>Code generation has proved to be a powerful tool to peel off abstraction layers, for instance in the duckplyr project. In R, code is data, and the language and the associated packages are very well suited for this task. The long-term goal is to turn DBItest into a <em>code generator</em> rather than a <em>test executor</em>: the test code will be generated from a specification directly into the backend package and executed there. In the case of a failure, the error message will point to the generated code and to the relevant part of the specification. Failing tests can be executed trivially, very much like failures in regular tests. The expected behavior becomes apparent from the generated code, leading to a better understanding of the failure and a more efficient debugging process.</p>
<p>A first step has been taken in this direction, the tests for the command execution and data retrieval flows via <code>dbBind()</code> have been refactored to generate inline code in the DBItest package. The process towards full code generation requires similar steps in a few other places to avoid hard-to-understand generated code, which would be even worse than the current situation.</p>
</section>
<section id="decoupling-from-backends" class="level3">
<h3 class="anchored" data-anchor-id="decoupling-from-backends">Decoupling from backends</h3>
<p>As DBItest continues to evolve, and more backends are using it, the ability to add or update checks without affecting all downstream packages becomes crucial. Each new or modified test will require the backend package to opt in by updating the DBItest version in their <code>tweaks()</code> call. Once the code generation is in place, this will become less of an issue, but for now this helps with the ongoing development.</p>
</section>
<section id="other-improvements" class="level3">
<h3 class="anchored" data-anchor-id="other-improvements">Other improvements</h3>
<p>The new Arrow generics are now tested in DBItest, and the tests have been integrated into the CI/CD pipeline.</p>
<p>A new tweak <code>allow_na_rows_affected</code> has been added to support <code>NA</code> values returned from <code>dbGetRowsAffected()</code> and passed as the <code>n</code> argument to <code>dbFetch()</code>.</p>
</section>
</section>
<section id="rsqlite-minor-update-to-2.3.6-continuous-updates-following-upstream-sqlite-releases" class="level2">
<h2 class="anchored" data-anchor-id="rsqlite-minor-update-to-2.3.6-continuous-updates-following-upstream-sqlite-releases">RSQLite: minor update to 2.3.6, continuous updates following upstream SQLite releases</h2>
<p>The automatic update of the bundled SQLite library has enabled continuous and timely updates of the RSQLite package on CRAN. The latest version of SQLite is 3.45.2, and the RSQLite package is now bundling it. For this reason, the known authors of SQLite have been added to the <code>DESCRIPTION</code> file. This process allows quicker updates of SQLite than if installing from <a href="https://repology.org/project/sqlite/versions">OS package repositories</a>, and precise control of the underlying SQLite version used in a project.</p>
<p>Other minor changes include support for the icpc compiler, and a new <code>sqliteIsTransacting()</code> function that returns if a transaction is active on the current connection.</p>
</section>
<section id="rpostgres-minor-update-to-1.4.6" class="level2">
<h2 class="anchored" data-anchor-id="rpostgres-minor-update-to-1.4.6">RPostgres: minor update to 1.4.6</h2>
<p>Maintenance only.</p>
</section>
<section id="rmariadb-minor-update-to-1.3.1" class="level2">
<h2 class="anchored" data-anchor-id="rmariadb-minor-update-to-1.3.1">RMariaDB: minor update to 1.3.1</h2>
<p>Unreleased version 1.3.1.9000 that avoids the deprecated <code>mysql_ssl_set()</code> function, pending discussion.</p>
<p>Support <code>TIME</code> columns with subsecond precision.</p>
<p>Use string as default for JSON (#296) and all unknown column types.</p>
<p>Connections now inherit from <code>"MySQLConnection"</code> if a MySQL server is detected (server version &lt; 10.0 and server description does not contain <code>"MariaDB"</code>). The new <code>mysql</code> argument to <code>dbConnect()</code> allows overriding the autodetection.</p>
<p>Support <code>dbSendStatement(immediate = TRUE)</code> and <code>dbExecute(immediate = TRUE)</code>, needs <code>CLIENT_MULTI_STATEMENTS</code>.</p>
</section>
<section id="adbi-new-release-in-collaboration-with-voltron-data-bridging-dbi-and-adbc-arrow-database-connectivity" class="level1">
<h1>adbi: new release in collaboration with Voltron Data, bridging DBI and adbc (Arrow Database Connectivity)</h1>
<p>The new adbi package bridges ADBC drivers and DBI. Examples include:</p>
<ul>
<li>adbcsqlite, on CRAN</li>
<li>adbcpostgresql, on CRAN</li>
<li><a href="https://github.com/apache/arrow-adbc/tree/main/r/adbcsnowflake">adbcsnowflake</a> for <a href="https://www.snowflake.com/">Snowflake</a></li>
<li><a href="https://github.com/apache/arrow-adbc/tree/main/r/adbcflightsql">adbcflightsql</a> for <a href="https://arrow.apache.org/docs/format/FlightSql.html">FlightSQL</a></li>
</ul>
<p><a href="https://arrow.apache.org/adbc/">ADBC</a> is</p>
<blockquote class="blockquote">
<p>an API standard for database access libraries that uses Arrow for result sets and query parameters.</p>
</blockquote>
<p>The adbi package allows existing code that uses DBI to seamlessly interact with the new ADBC drivers, but this will not improve performance. To facilitate the switch to using Arrow as a data interchange format, adbi supports access via data frames and Arrow side by side, on the same connection object, using the new generics defined by DBI. For example, with <code>dbGetQueryArrow()</code>, the result set is passed to R as an Arrow stream, bypassing the expensive conversion to data frames. The subsequent section contains a more detailed example.</p>
<p>Development of the adbi package has been made easy with the RKazam package, which is a template for creating DBI backends, and the DBItest package, which provides a battery of tests that all âpassâ with the package generated from the template and help guide the development process. Thanks to Nicolas Bennett for implementation and the wonderful collaboration, and to Voltron Data for supporting this effort.</p>
<section id="dbi3" class="level2">
<h2 class="anchored" data-anchor-id="dbi3">dbi3?</h2>
<p>The following example illustrates the various connectivity options with a PostgreSQL database. In all scenarios, the libpq library is used to communicate with the database server. The RPostgres package links to libpq and uses this API directly to retrieve and ingest data from R via the DBI interface. The adbcpostgresql package also links to libpq but exposes ADBC, which is brought to R with the adbcdrivermanager package. On top of that, the adbi package interacts with arbitrary ADBC drivers (including adbcpostgresql) and exposes the functionality through DBI. The R user has the choice to access the data via data frames or via Arrow. Only when using adbi and the new <code>dbGetQueryArrow()</code>, the implementation will never convert the data to R data frames. In all other cases, a conversion to R data frames will occur.</p>
<p>FIXME: Add figure from Excalidraw.</p>
<p>While the Arrow path seems to involve more components, it is the most efficient way to interact with the database because the data is threaded through from adbcpostgresql to R without any conversion or even copying. The only conversion occurs in adbcpostgresql, when the data returned by libpq is converted to Arrow format. With FlightSQL, the data will be passed in the Arrow format end to end, this requires support in the database <em>server</em>. This is a promising development. By using adbi or adbcdrivermanager, R users can seamlessly transition to FlightSQL when it becomes available in their database.</p>
<ul>
<li><p>n host systems x m databases</p></li>
<li><p>What boxes are ticked by using adbcdrivermanager?</p></li>
</ul>
<section id="review-async" class="level3">
<h3 class="anchored" data-anchor-id="review-async">Review async</h3>
</section>
</section>
<section id="what-is-dbi" class="level2">
<h2 class="anchored" data-anchor-id="what-is-dbi">What is DBI?</h2>
<p>The {DBI} package (<strong>d</strong>ata<strong>b</strong>ase <strong>i</strong>nterface) provides an abstraction for communication between R and database management systems (DBMSes) by specifying a common application programming interface (API). Actual connectivity to DBMSes is established via database specific <a href="https://github.com/r-dbi/backends#readme">backend packages</a>, implementing this interface. Examples for such backends include <a href="https://rpostgres.r-dbi.org/">RPostgres</a>, <a href="https://rmariadb.r-dbi.org/">RMariaDB</a>, and <a href="https://rsqlite.r-dbi.org/">RSQLite</a>. For users that are new to DBI, the <a href="https://dbi.r-dbi.org/articles/dbi">introductory tutorial</a> provides a good entry point for getting acquainted with some key concepts.</p>
<p>This blog post summarizes recent developments in {DBI} and related packages and concludes with an outlook on potential future directions. Similar articles are available from previous years, reporting on earlier states of the {DBI} ecosystem:</p>
<ul>
<li><a href="https://www.r-dbi.org/blog/dbi-3-3/">3/4: January 2021</a></li>
<li><a href="https://www.r-dbi.org/blog/dbi-3-2/">2/4: December 2019</a></li>
<li><a href="https://www.r-dbi.org/blog/dbi-3-1/">1/4: December 2018</a></li>
</ul>
</section>
<section id="recent-developments" class="level2">
<h2 class="anchored" data-anchor-id="recent-developments">Recent developments</h2>
<p>Several packages associated with DBI have been updated since <a href="https://www.r-dbi.org/blog/dbi-3-3/">early 2021</a>:</p>
<ul>
<li>DBI 1.1.1 -&gt; 1.1.2 (<a href="https://dbi.r-dbi.org/news/">NEWS</a>)</li>
<li>RMariaDB 1.1.0 -&gt; 1.2.1 (<a href="https://rmariadb.r-dbi.org/news/">NEWS</a>)</li>
<li>RPostgres 1.3.1 -&gt; 1.4.3 (<a href="https://rpostgres.r-dbi.org/news/">NEWS</a>)</li>
<li>RSQLite 2.2.2 -&gt; 2.2.9 (<a href="https://rsqlite.r-dbi.org/news/">NEWS</a>)</li>
<li>DBItest 1.7.0 -&gt; 1.7.2 (<a href="https://dbitest.r-dbi.org/news/">NEWS</a>)</li>
</ul>
<p>And the following sections elaborate on some of the noteworthy changes and improvements contained in these updates, both user-visible and internal.</p>
<section id="clickable-method-documentation" class="level3">
<h3 class="anchored" data-anchor-id="clickable-method-documentation">Clickable method documentation</h3>
<p>The DBI method reference on <a href="https://dbi.r-dbi.org/reference/" class="uri">https://dbi.r-dbi.org/reference/</a> has been updated to include clickable links to known DBI backends. This makes documentation specific to certain backends more accessible, as optional function arguments used by some backend implementations are only documented by the respective packages.</p>
</section>
<section id="full-support-for-aws-redshift" class="level3">
<h3 class="anchored" data-anchor-id="full-support-for-aws-redshift">Full support for AWS Redshift</h3>
<p>Redshift support has been greatly improved by Adam ForyÅ as part of the RPostgres package and both databases now pass all applicable tests offered by DBItest. The BLOB data type is currently not supported by Redshift and consequently, related tests are skipped. For connecting to a Redshift cluster, the RPostgres package exports <code>Redshift()</code> (to be used over <code>Postgres()</code>).</p>
</section>
<section id="faster-table-imports" class="level3">
<h3 class="anchored" data-anchor-id="faster-table-imports">Faster table imports</h3>
<p>Previous versions of {RMariaDB} and {RPostgres} relied <code>dbBind()</code> for writing tables, using a prepared <code>INSERT INTO ... VALUES (...)</code> statement with placeholders. Contrary to the expectation, this was very inefficient, because each row requires a communication roundtrip to the server. To improve the situation, {RMariaDB} now uses <code>LOAD DATA LOCAL INFILE</code> to load data from a temporary CSV file. Recent MySQL server versions disable this capability by default, and therefore it is also disabled by default in {RMariaDB}. If your server supports this, enable fast loading by passing <code>load_data_local_infile = TRUE</code> to <code>dbConnect()</code>. For {RPostgres}, <code>dbAppendTable()</code> has been updated to use the same optimization as <code>dbWriteTable()</code> when writing data.</p>
</section>
<section id="windows-compatibility" class="level3">
<h3 class="anchored" data-anchor-id="windows-compatibility">Windows compatibility</h3>
<p>{RMariaDB} can now use the <code>caching_sha2_password</code> plugin on Windows which was permanently disabled on previous versions. This is important for connecting to recent versions of MySQL which require this plugin.</p>
</section>
<section id="extended-data-types-for-sqlite" class="level3">
<h3 class="anchored" data-anchor-id="extended-data-types-for-sqlite">Extended data types for SQLite</h3>
<p>Thanks to Eric Anderson, {RSQLite} now returns typed data for columns declared with <code>DATE</code>, <code>TIME</code> and <code>TIMESTAMP</code> data types. To enable this feature, <code>extended_types = TRUE</code> has to be passed in <code>dbConnect()</code>.</p>
</section>
<section id="interrupt-handling" class="level3">
<h3 class="anchored" data-anchor-id="interrupt-handling">Interrupt handling</h3>
<p>The <code>check_interrupts = TRUE</code> argument to <code>dbConnect()</code> in {RPostgres} now correctly cancels the query and returns to the user as soon as an interrupt is signalled (by pressing Ctrl+C or Escape in RStudio). Thanks to Mateusz Å»Ã³Åtak for tests and discussion.</p>
</section>
<section id="automation" class="level3">
<h3 class="anchored" data-anchor-id="automation">Automation</h3>
<p>{RMariaDB} is tested against all combinations of major MariaDB and MySQL client/server releases, while {RPostgres} is tested against all versions of PostgreSQL â¥ 10 using GitHub Actions. This guarantees compatibility with a broader range of database instances for both backends and for future updates to the corresponding packages. All tests are run daily, thereby ensuring that upstream updates remain compatible with backend implementations. The database servers are installed on GitHub Actions using dedicated actions for installing <a href="https://github.com/ankane/setup-mariadb/">MariaDB</a>, <a href="https://github.com/ankane/setup-mysql">MySQL</a> and <a href="https://github.com/ankane/setup-postgres">Postgres</a>, maintained by Andrew Kane.</p>
<p>Thanks to the automated monitoring of SQLite3 releases, the vendored code can be updated continuously with minimal delay over upstream releases. {RSQLite} now uses SQLite3 3.37.0 and became available from CRAN only 10 days after the upstream release.</p>
</section>
<section id="simpler-upgrade-path-for-dbitest" class="level3">
<h3 class="anchored" data-anchor-id="simpler-upgrade-path-for-dbitest">Simpler upgrade path for DBItest</h3>
<p>By making it possible for backends to specify the supported version of {DBItest}, using <code>tweaks(dbitest_version = "x.y.z")</code>, it is now simpler to update {DBItest} on CRAN. Newly added tests in {DBItest} are skipped if the declared version is too low. Skipped tests are reported in the test results and can be fixed independently of the {DBItest} releases.</p>
</section>
<section id="inlined-boost-headers" class="level3">
<h3 class="anchored" data-anchor-id="inlined-boost-headers">Inlined Boost headers</h3>
<p>The {BH} package is a C++ header-only package containing in excess of 10,000 individual files and installation has proven challenging for some systems, such as Amazonâs Elastic File System. By vendoring only the required files into {RSQLite}, {RMariaDB} and {RPostgres}, it is no longer necessary to install {BH} to use these packages, and therefore the total number of files required to build these packages is greatly reduced. Thanks to RStudio for supporting this change.</p>
</section>
<section id="reorganized-structure-of-the-r-code" class="level3">
<h3 class="anchored" data-anchor-id="reorganized-structure-of-the-r-code">Reorganized structure of the R code</h3>
<p>{DBI} uses S4 classes and generic functions to specify the interface to be implemented by backends, using database specific subclasses. Class specific generic implementations are consequently declared with <code>setMethod()</code>, using the following convention:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setMethod</span>(<span class="st">"foo"</span>, <span class="fu">c</span>(<span class="st">"myclass"</span>, <span class="st">"character"</span>), <span class="cf">function</span>(x, char_arg, ...) {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Instead of passing an anonymous function as <code>definition</code> argument to <code>setMethod()</code>, this has been changed to a semantic equivalent which is more explicit:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>foo_myclass_character <span class="ot">&lt;-</span> <span class="cf">function</span>(x, char_arg, ...) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">setMethod</span>(<span class="st">"foo"</span>, <span class="fu">c</span>(<span class="st">"myclass"</span>, <span class="st">"character"</span>), foo_myclass_mycharacter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Reasons for this transformation were to make the respective implementations more accessible, as function definitions now can be displayed more easily via <code>mypkg:::foo_myclass_character</code>, and to generally make the code-base easier to read and navigate. In similar spirit, each such generic implementation is now defined in its own file with file names constructed as <code>foo_myclass_mycharacter.R</code>. This makes it immediately clear, exactly which methods are implemented by a package, simply from the list of associated files. Code transformation was carried out in semi-automated fashion, with the help of a <a href="https://github.com/pre-processing-r/rpp/blob/main/script/un-s4.R">script</a> that uses infrastructure from the âPre-processing R codeâ project.</p>
</section>
</section>
<section id="future-work" class="level2">
<h2 class="anchored" data-anchor-id="future-work">Future work</h2>
<p>The {DBI} package provides a low-level interface for database connectivity with a <a href="https://www.r-dbi.org/blog/dbi-3-3/">narrow scope</a>. Data query and manipulation tasks that are not in-scope for {DBI} are currently left to auxiliary packages, including <a href="https://dbplyr.tidyverse.org/">dbplyr</a>, <a href="https://cynkra.github.io/dm/">dm</a>, <a href="https://github.com/ankane/dbx">dbx</a> and <a href="https://winvector.github.io/rquery/">rquery</a>. {DBI} uses S4, one of several systems for object-oriented programming in R. While S4 offers several advantages over its predecessor S3, including increased strictness and multiple dispatch, it also is more rigid compared to S3. <!-- I don't see how this is specific to S4, but then again, I haven't really used S4 myself, so I'm no expert; it might still be worthwhile to elaborate a bit here --> <!-- also, what is the intention of discussing S4 here? is it to justify a move away from S4? if so I feel a need for fleshing out this argument more --> Consequently, once the definition of a generic is published, it is difficult to make changes without breaking downstream dependencies.</p>
<p>The first release of {DBI} dates back roughly 20 years and since, the package has been widely adopted by others, both for accessing databases or providing <a href="https://github.com/r-dbi/backends#readme">backends</a> to DBMSes. Its success, combined with the rigidity imposed by S4, has made it difficult to extend the interface beyond what is currently offered. When considering new additions, there is pressure to get it right in the first attempt, thereby holding back less essential improvements.</p>
<p>The DBI specification in the {DBItest} package aims to standardize the feature set of {DBI}-compliant backends, and to provide a test suite against which conformity of an implementation can be verified. Due to differences in design of individual DBMSes, not all features of the DBI specification and therefore not all tests provided by {DBItest} are supported by all backend packages. Using a newly introduced mechanism, backends can declare, by means of <em>tweaks</em>, which tests to run in what way. This addresses some of the problems associated with implementing a test suite that can be re-used for several backends. General-purpose clients however, can only make guesses as to the exact feature set supported by a given backend or connection. There currently is no formal way to declare certain capabilities as missing (or available).</p>
<p>Based on these observations, for extending DBI, it may be worthwhile to address the following two issues:</p>
<ol type="1">
<li>Formal declaration of capabilities.</li>
<li>Decoupling the user from the backend interface.</li>
</ol>
<p>The new <a href="https://github.com/r-dbi/dbi3">dbi3 repository</a> contains a collection of issues, some of which will be easier to address after these changes are in place.</p>
<section id="capabilities" class="level3">
<h3 class="anchored" data-anchor-id="capabilities">Capabilities</h3>
<p>A mechanism is introduced by which backends can declare explicitly which features of DBI a particular connection supports. Examples for existing functionality that varies over backends include:</p>
<ul>
<li>Support for BLOBs (not available e.g.&nbsp;in Redshift).</li>
<li>Support for logical columns (not available e.g.&nbsp;in SQL Server or SQLite).</li>
<li>Support for named or nested transactions (not standardized).</li>
<li>Placeholder character to use in parameterized queries (different across databases).</li>
</ul>
<p>In the future, backends may also indicate:</p>
<ul>
<li>Whether asynchronous queries are supported (important for web development).</li>
<li>Whether the database supports SQL or a different query language (DBI currently assumes SQL).</li>
</ul>
<p>The list of possible capabilities will be maintained by DBI and {DBItest} will rely solely on these capabilities, foregoing the current <em>tweaking</em> mechanism. Users can in turn query these capabilities and act accordingly.</p>
</section>
<section id="separate-user-interface" class="level3">
<h3 class="anchored" data-anchor-id="separate-user-interface">Separate user interface</h3>
<p>As an evolution of the current approach, where users of DBI will often directly call methods that are mostly implemented by backends themselves, introduction of a separate user-facing API may be worthwhile. Based on plain functions and essentially providing a <a href="https://en.wikipedia.org/wiki/Facade_pattern">facade</a>, this user interface would be sufficient for the overwhelming majority of use cases. At the same time, such an approach should contribute to simpler code with less duplication in backend packages.</p>
<p>The new user interface performs tasks that are common to all database backends (e.g.&nbsp;validation of arguments), and calls methods provided by the backends, in some cases dependent on declared capabilities. Overall, this should lead to less code that needs to be reimplemented across backends. The decoupling of interfaces could help with iterative improvements, while guaranteeing stability for users. As an example, a <code>dbi_write_table()</code> function that optionally creates and writes data to a database table might encompass the following functionality:</p>
<ul>
<li>If the backend supports transactions:
<ul>
<li>Call <code>dbi_is_transacting()</code> to determine if the statement is occurring as part of a transaction.</li>
<li>Call <code>dbi_begin_transaction()</code> if it is not already part a transaction.</li>
<li>Use <code>dbi_begin_transaction(name = "...")</code> if the backend supports named transactions.</li>
</ul></li>
<li>Call <code>dbi_remove_table()</code> and/or <code>dbi_create_table()</code> if necessary.</li>
<li>Call <code>dbi_append_table()</code>.</li>
<li>Call <code>dbi_commit()</code> on success or <code>dbi_rollback()</code> on failure whenever transactions are supported.</li>
</ul>
<p>For appending rows to a table, <code>dbi_append_table()</code> might check if the backend supports streaming uploads or if SQL should be created for inserting rows. In the latter case, the SQL statement (or multiple statements for large tables) could be constructed using quoted literals obtained from <code>dbi_quote_literal()</code>. The backend could indicate the maximum supported length of a statement, so that splitting of large tables into multiple chunks can happen automatically.</p>
<p>As a final example, a backend supporting asynchronous operations might rely entirely on DBI for providing the corresponding blocking operations. The asynchronous procedure provided by the backend could automatically be wrapped by a DBI function that only returns upon completion.</p>
<p>Such a split API would allow for generics declared by {DBI} for interfacing with backends to remain frozen. To extend or alter the signature of a generic, a new generic can be added, using some form of versioning (e.g.&nbsp;with a numeric suffix, such as <code>dbAppendTable1()</code>, <code>dbAppendTable2()</code>, etc.). With such an architecture, arguments in generics could be declared explicitly, without relying on forwarding via <code>...</code>, as is done currently. The user is presented with a stable API with only backward-compatible changes, {DBI} internally decides which versions of a method to call. When a new version of a generic is introduced, {DBI} documents and proposes an upgrade path for backend implementers. In the long run this would also allow for transitioning to another object-oriented system such as S3 or <a href="https://github.com/RConsortium/OOP-WG/">R7</a> without introducing user-facing breaking changes.</p>
<p>This approach also enables support of rich callbacks: each function in the facade can notify listeners on entry and before returning. For example, a call to <code>dbi_connect()</code> would notify interested parties that a new connection has been established, and a call to <code>dbi_query()</code> issues callbacks with the query and the result. Potential use cases include:</p>
<ul>
<li>Logging as in {dblog}.</li>
<li>The <em>Connections</em> pane in RStudio.</li>
<li>Mocking (with hooks) as in {dittodb}.</li>
</ul>
<p>A versioning scheme could also be implemented for callbacks, keeping existing callbacks frozen while allowing for addition of new features that alter callback signatures.</p>
</section>
</section>
<section id="acknowledgments" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgments">Acknowledgments</h2>
<p>Iâd like to thank Jeroen Ooms and GÃ¡bor CsÃ¡rdi for providing crucial infrastructure to support this and many other projects in the R ecosystem.</p>
<p>Thanks to the numerous contributors to the packages in the âMaintaining DBIâ project in 2021:</p>
<ul>
<li>DBI: <a href="https://github.com/bwohl">@bwohl</a>, <a href="https://github.com/cboettig">@cboettig</a>, <a href="https://github.com/dcassol">@dcassol</a>, <a href="https://github.com/jawond">@jawond</a>, <a href="https://github.com/mmccarthy404">@mmccarthy404</a>, <a href="https://github.com/pnacht">@pnacht</a>, <a href="https://github.com/r2evans">@r2evans</a>, <a href="https://github.com/vituri">@vituri</a>, and <a href="https://github.com/zoushucai">@zoushucai</a>;</li>
<li>RSQLite: <a href="https://github.com/ablack3">@ablack3</a>, <a href="https://github.com/billy34">@billy34</a>, <a href="https://github.com/edwindj">@edwindj</a>, <a href="https://github.com/gaborcsardi">@gaborcsardi</a>, <a href="https://github.com/ggrothendieck">@ggrothendieck</a>, <a href="https://github.com/giocomai">@giocomai</a>, <a href="https://github.com/habilzare">@habilzare</a>, <a href="https://github.com/honghh2018">@honghh2018</a>, <a href="https://github.com/Jeff-Gui">@Jeff-Gui</a>, <a href="https://github.com/kevinushey">@kevinushey</a>, <a href="https://github.com/mgirlich">@mgirlich</a>, <a href="https://github.com/plantton">@plantton</a>, <a href="https://github.com/schuemie">@schuemie</a>, <a href="https://github.com/Shicheng-Guo">@Shicheng-Guo</a>, and <a href="https://github.com/tschoonj">@tschoonj</a>;</li>
<li>RPostgres: <a href="https://github.com/aleaficionado">@aleaficionado</a>, <a href="https://github.com/armenic">@armenic</a>, <a href="https://github.com/ateucher">@ateucher</a>, <a href="https://github.com/baderstine">@baderstine</a>, <a href="https://github.com/beralef">@beralef</a>, <a href="https://github.com/carlganz">@carlganz</a>, <a href="https://github.com/ColinFay">@ColinFay</a>, <a href="https://github.com/dcaud">@dcaud</a>, <a href="https://github.com/dpprdan">@dpprdan</a>, <a href="https://github.com/f-ritter">@f-ritter</a>, <a href="https://github.com/galachad">@galachad</a>, <a href="https://github.com/GitHubGeniusOverlord">@GitHubGeniusOverlord</a>, <a href="https://github.com/gontcharovd">@gontcharovd</a>, <a href="https://github.com/gtm19">@gtm19</a>, <a href="https://github.com/hadley">@hadley</a>, <a href="https://github.com/jakob-r">@jakob-r</a>, <a href="https://github.com/jeroen">@jeroen</a>, <a href="https://github.com/jkylearmstrong">@jkylearmstrong</a>, <a href="https://github.com/JSchoenbachler">@JSchoenbachler</a>, <a href="https://github.com/matthewgson">@matthewgson</a>, <a href="https://github.com/mgirlich">@mgirlich</a>, <a href="https://github.com/mmuurr">@mmuurr</a>, <a href="https://github.com/mskyttner">@mskyttner</a>, <a href="https://github.com/phedinkus">@phedinkus</a>, <a href="https://github.com/ppssphysics">@ppssphysics</a>, <a href="https://github.com/RakeshG1">@RakeshG1</a>, <a href="https://github.com/rickbpdq">@rickbpdq</a>, <a href="https://github.com/samiaab1990">@samiaab1990</a>, <a href="https://github.com/sawnaanwas">@sawnaanwas</a>, <a href="https://github.com/tomasjanikds">@tomasjanikds</a>, <a href="https://github.com/vspinu">@vspinu</a>, <a href="https://github.com/waynelapierre">@waynelapierre</a>, <a href="https://github.com/zmbc">@zmbc</a>, and <a href="https://github.com/zozlak">@zozlak</a>;</li>
<li>RMariaDB: <a href="https://github.com/bakiunal">@bakiunal</a>, <a href="https://github.com/dirkschumacher">@dirkschumacher</a>, <a href="https://github.com/hadley">@hadley</a>, <a href="https://github.com/jeroen">@jeroen</a>, <a href="https://github.com/Mosk915">@Mosk915</a>, <a href="https://github.com/noamross">@noamross</a>, <a href="https://github.com/paulmaunders">@paulmaunders</a>, <a href="https://github.com/retowyss">@retowyss</a>, <a href="https://github.com/rorynolan">@rorynolan</a>, <a href="https://github.com/twentytitus">@twentytitus</a>, <a href="https://github.com/verajosemanuel">@verajosemanuel</a>, <a href="https://github.com/wiligl">@wiligl</a>, <a href="https://github.com/Woosah">@Woosah</a>, and <a href="https://github.com/zoushucai">@zoushucai</a>.</li>
<li>DBItest: <a href="https://github.com/adamsma">@adamsma</a>, and <a href="https://github.com/michaelquinn32">@michaelquinn32</a>;</li>
</ul>
<p>Thanks also to Nicolas Bennett for reviewing and editing this blog post.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/maelle\.github\.io\/rdbidotorg\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 Â© Licence MIT.
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://www.r-consortium.org/">
<p>Sponsored by the R Consortium.</p>
</a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>